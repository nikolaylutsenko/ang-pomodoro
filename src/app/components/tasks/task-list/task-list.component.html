<!-- Filter and Sort Controls -->
<div class="task-controls">
  <input
    type="text"
    placeholder="Filter by description"
    [(ngModel)]="filterText"
    (ngModelChange)="filterChanged.emit(filterText)"
  />
  <button (click)="toggleSort()">
    Sort by Date: {{ sortDesc ? 'Newest' : 'Oldest' }}
  </button>
</div>

<!-- Tasks Table -->
<table class="tasks-table">
  <thead>
    <tr>
      <th><input type="checkbox" (change)="toggleSelectAll($event)" [checked]="areAllTasksSelected() && filteredAndSortedTasks.length > 0"></th> <!-- Added select-all checkbox -->
      <th>Priority</th> <!-- Added Priority Header -->
      <th>Description</th>
      <th>Urgency</th> <!-- Changed from Priority -->
      <th>Date Created</th>
      <th>Est. Hours</th>
      <th>Intervals</th>
      <th>Completed</th>
      <th>Status</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody cdkDropList [cdkDropListData]="filteredAndSortedTasks" (cdkDropListDropped)="drop($event)">
    <tr *ngFor="let task of filteredAndSortedTasks" cdkDrag [cdkDragDisabled]="task.completionStatus === TaskStatus.Completed" [ngClass]="{
      'urgency-low': task.urgency === 'Low',
      'urgency-mid': task.urgency === 'Mid',
      'urgency-high': task.urgency === 'High',
      'selected': selectedTaskIds.has(task.id)
    }" [class.completed]="task.completionStatus === TaskStatus.Completed">
      <ng-template cdkDragPreview>
        <tr [ngClass]="{
          'urgency-low': task.urgency === 'Low',
          'urgency-mid': task.urgency === 'Mid',
          'urgency-high': task.urgency === 'High',
          'dragging-preview': true
        }">
          <td><!-- Checkbox for preview can be omitted or static --></td>
          <td>{{ task.priority }}</td> <!-- Added Priority to Drag Preview -->
          <td>{{ task.description | slice:0:300 }}{{ task.description.length > 300 ? '...' : '' }}</td>
          <td>{{ task.urgency }}</td>
          <td>{{ task.dateCreated | date:'short' }}</td>
          <td>{{ (task.workIntervals === '∞' || task.workIntervals === '?') ? task.workIntervals : task.estimatedHours }}</td>
          <td>{{ task.workIntervals }}</td>
          <td>{{ task.completedIntervals }}</td>
          <td>{{ task.completionStatus }}</td>
          <td>Actions</td>
        </tr>
      </ng-template>
      <td><input type="checkbox" [checked]="selectedTaskIds.has(task.id)" (change)="onTaskSelectionChange(task.id, $event)"></td> <!-- Added checkbox to each row -->
      <td>{{ task.priority }}</td> <!-- Added Priority Cell -->
      <td>
        <span *ngIf="!expandedDescriptions[task.id] && task.description.length > 300">
          {{ task.description | slice:0:300 }}...
          <a class="show-more-link" (click)="toggleDescription(task.id)">Show more</a>
        </span>
        <span *ngIf="expandedDescriptions[task.id] && task.description.length > 300">
          {{ task.description }}
          <a class="show-more-link" (click)="toggleDescription(task.id)">Show less</a>
        </span>
        <span *ngIf="task.description.length <= 300">
          {{ task.description }}
        </span>
      </td>
      <td>{{ task.urgency }}</td>
      <td>{{ task.dateCreated | date:'short' }}</td>
      <td>{{ (task.workIntervals === '∞' || task.workIntervals === '?') ? task.workIntervals : task.estimatedHours }}</td>
      <td>{{ task.workIntervals }}</td>
      <td>{{ task.completedIntervals }}</td>
      <td>{{ task.completionStatus }}</td>
      <td>
        <span *ngIf="task.completionStatus !== TaskStatus.Completed" class="icon-btn" title="Complete Task" (click)="completeTaskClicked(task)">✔️</span>
        <span *ngIf="task.completionStatus !== TaskStatus.Completed" class="icon-btn" title="Edit" (click)="editTaskClicked(task)">✏️</span>
        <span class="icon-btn" title="Delete" (click)="deleteTaskClicked(task.id)">🗑️</span>
      </td>
    </tr>
    <tr *ngIf="filteredAndSortedTasks.length === 0">
      <td colspan="10">No tasks found.</td> <!-- Adjusted colspan -->
    </tr>
  </tbody>
</table>

<!-- Add New Task Button -->
<button class="add-task-btn" (click)="openCreateTaskModal()">
  <span>+</span>
</button>

<!-- Create Task Modal -->
<div *ngIf="showCreateTaskModal" class="modal-overlay" (click)="closeCreateTaskModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <app-create-task
      [taskToEdit]="taskToEditInModal"
      (taskSaved)="handleTaskSavedFromModal($event)"
      (cancelEdit)="closeCreateTaskModal()">
    </app-create-task>
  </div>
</div>
